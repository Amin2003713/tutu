@page "/login"
@using Application.User.Auth.CommandAndQueries
@using MyShop.Ui.Commen.Footers
@layout AuthenticationLayout


<MudCard class="auth-form shadow-around">
    <MudContainer class="site-logo">
        <MudImage Alt="Amin Sites"
                  Src="./assets/images/logo.png"/>


    </MudContainer>
    <MudCardHeader Class="auth-form-title">
        ورود به همتا
    </MudCardHeader>
    <MudCardContent>
        <EditForm Model="_model" OnValidSubmit="SubmitAsync"
                  FormName="LoginForm" Enhance="true">

            <DataAnnotationsValidator/>

            <MudGrid>
                <MudItem xs="10" sm="12">

                    <MudTextField
                        @bind-Value="_model.PhoneNumber"
                        Class="input-element"
                        For="@(() => _model.PhoneNumber)"
                        Validation="_model.PhoneNumber"
                        HelperText="09130000000"
                        Variant="Variant.Text"
                        HelperTextOnFocus="true"/>


                    <MudTextField
                        Class="mt-3 form-element-row"
                        Validation="_model.Password"
                        @bind-Value="@_model.Password"
                        For="@(() => _model.Password)"
                        HelperText="********"
                        Variant="Variant.Text"
                        HelperTextOnFocus="true"
                        Adornment="Adornment.End"
                        InputType="@_passwordInput"
                        AdornmentIcon="@_passwordInputIcon"
                        OnAdornmentClick="TogglePasswordVisibility"
                        AdornmentColor="Color.Error"
                        AdornmentAriaLabel="Show Password"/>


                    <MudCardActions>
                        <MudButton
                            ButtonType="ButtonType.Submit"
                            Variant="Variant.Filled"
                            Color="Color.Primary"
                            Class="ml-auto">
                            ورود
                        </MudButton>
                    </MudCardActions>
                </MudItem>
            </MudGrid>
        </EditForm>
    </MudCardContent>
    <MudCardContent>
        <MiniFooter/>
    </MudCardContent>
</MudCard>

@code
{
    private LoginCommand _model = new();

    protected override async Task OnInitializedAsync()
    {
        var state = await _stateProvider.GetAuthenticationStateAsync();

        if (state.User.Identity!.IsAuthenticated)
        {
            _navigationManager.NavigateTo("/");
        }
    }

    private async Task SubmitAsync()
    {
        var result = await _authenticationManager.Login(_model);
        if (result.IsSuccess)
        {
            _snackBar.Add( _model.PhoneNumber, Severity.Success);
            _navigationManager.NavigateTo("/", true);
        }
        else
        {
            
                _snackBar.Add(result.MetaData.Message, Severity.Error);
            
        }
    }

    private bool _passwordVisibility;
    private InputType _passwordInput = InputType.Password;
    private string _passwordInputIcon = Icons.Material.Filled.VisibilityOff;

    void TogglePasswordVisibility()
    {
        if (_passwordVisibility)
        {
            _passwordVisibility = false;
            _passwordInputIcon = Icons.Material.Filled.VisibilityOff;
            _passwordInput = InputType.Password;
        }
        else
        {
            _passwordVisibility = true;
            _passwordInputIcon = Icons.Material.Filled.Visibility;
            _passwordInput = InputType.Text;
        }
    }
}