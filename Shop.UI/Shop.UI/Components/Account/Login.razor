@page "/Auth/Login"
@using Shop.UI.Client.Features.Auth.Pages.Controles



@layout AuthLayout
@rendermode InteractiveServer

<AntiforgeryToken>@(new AntiforgeryToken())</AntiforgeryToken>


<EditForm Model="LoginCommand" OnValidSubmit="LoginUser" FormName="LoginForm" Enhance="@true"
          class="auth-form shadow-around">
    <DataAnnotationsValidator/>
    <div class="site-logo">
        <a href="#">
            <img src="./assets/images/logo.png" alt="logo">
        </a>
    </div>
    <div class="auth-form-title">
        ورود به سامانه
    </div>

    <AuthInput Label="نام کاربری/شماره همراه" Icon="fad fa-mobile-alt">
        <Control>
            <InputText @bind-Value="LoginCommand.PhoneNumber" class="input-element"
                       id="phone-number"/>
        </Control>
        <Validation>
            <ValidationMessage For="@(() => LoginCommand.PhoneNumber)"/>
        </Validation>
    </AuthInput>

    <AuthInput Label="کلمه عبور" Icon="fad fa-key-skeleton">
        <Control>
            <InputText @bind-Value="LoginCommand.Password" class="input-element" id="password"/>
        </Control>
        <Anchor>
            <AuthAnchor class="link--with-border-bottom" NavigationText="رمز عبور خود را فراموش کرده‌ام"
                        ToAddress="/Auth/ForgetPassword">
            </AuthAnchor>
        </Anchor>
        <Validation>
            <ValidationMessage For="@(() => LoginCommand.Password)"/>
        </Validation>
    </AuthInput>

    <AuthButton ButtonText="ورود به همتا" class="btn-element btn-info-element" Icon="fad fa-sign-in-alt"/>

    <AuthAnchor class="link--with-border-bottom" Label="کاربر جدید هستید" NavigationText="ثبت نام در همتا"
                ToAddress="/Auth/Register"/>
</EditForm>

@code {

    [SupplyParameterFromForm(FormName = "LoginForm")]
    public LoginCommand LoginCommand { get; set; } = new();

[CascadingParameter] private HttpContext HttpContext { get; set; } = default!;

public async Task LoginUser()
    {
        try
        {
// Perform login via your service
            var result = await Auth.Login(LoginCommand);

            if (!result.result)
            {
                ShowSnackBar(result.massage);
                LoginCommand = new LoginCommand();
                return;
            }

// // Ensure HttpContext and HttpContextAccessor are available and not null
//             if (HttpContext == null || HttpContext.HttpContext is null)
//             {
//                 ShowSnackBar("HttpContext is not available.");
//                 return;
//             }

            
// Sign in using the authentication scheme (e.g., Cookie Authentication)
            await HttpContext.SignInAsync(
                "Bearer",
                result.Token!,
                new AuthenticationProperties { IsPersistent = true }
            );

// Redirect after successful sign-in to prevent further response rendering
            NavigationManager.NavigateTo("/Auth/ForgetPassword");

// Optionally prevent further rendering
        }
        catch (NotFoundException ex)
        {
            ShowSnackBar(ex.Message);
        }
        catch (HttpRequestException ex)
        {
            ShowSnackBar(ex.Message);
        }
        catch (Exception ex)
        {
            ShowSnackBar("An unexpected error occurred.");
            Console.WriteLine(ex.Message); // Log the full error details for debugging
        }
    }


    private void ShowSnackBar(string message)
    {
        Snackbar.Clear();
        Snackbar.Add($"{message}", Severity.Error, c =>
        {
            c.SnackbarVariant = Variant.Text;
            c.HideIcon = true;
            c.DuplicatesBehavior = SnackbarDuplicatesBehavior.Prevent;
            c.CloseAfterNavigation = true;
            c.Onclick = snackbar =>
            {
                snackbar.Dispose();
                return Task.CompletedTask;
            };
        });
    }

}