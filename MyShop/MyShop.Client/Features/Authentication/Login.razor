@page "/login"
@using Application.User.Auth.CommandAndQueries
@rendermode  InteractiveWebAssembly

@layout AuthenticationLayout


<MudCard class="auth-form shadow-around">
    <MudContainer class="site-logo">
        <MudImage Alt="Amin Sites"
                  Src="./assets/images/logo.png"/>


    </MudContainer>
    <MudCardHeader Class="auth-form-title">
        ورود به همتا
    </MudCardHeader>
    <MudCardContent >
        <EditForm Model="Model" OnValidSubmit="SubmitAsync"
                  FormName="Login" Enhance="true">

            <DataAnnotationsValidator/>

            <MudGrid>
                <MudItem xs="12" sm="12">

                    <MudTextField
                        @bind-Value="Model.PhoneNumber"
                        Class="input-element"
                        For="@(() => Model.PhoneNumber)"
                        Validation="Model.PhoneNumber"
                        HelperText="09130000000"
                        Variant="Variant.Outlined"
                        HelperTextOnFocus="true"/>


                    <MudTextField    
                        Class="mt-3 form-element-row"
                        Validation="Model.Password"
                        @bind-Value="@Model.Password"
                        For="@(() => Model.Password)"
                        HelperText="********"
                        Variant="Variant.Outlined"
                        HelperTextOnFocus="true"
                        InputType="@_passwordInput"
                        AdornmentIcon="@_passwordInputIcon"
                        OnAdornmentClick="TogglePasswordVisibility"
                        AdornmentColor="Color.Error"
                        AdornmentAriaLabel="Show Password"/>


                    <MudCardActions>
                        <MudButton 
                            ButtonType="ButtonType.Submit"
                            Variant="Variant.Filled"
                            Color="Color.Primary"
                            EndIcon="@Icons.Material.Filled.Login"
                            Class="ml-auto">
                            ورود
                        </MudButton>
                    </MudCardActions>
                </MudItem>
            </MudGrid>
        </EditForm>
    </MudCardContent>
</MudCard>


@code
{
    [SupplyParameterFromForm( FormName = "Login")] private LoginCommand Model { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        var state = await _stateProvider.GetAuthenticationStateAsync();

        if (state.User.Identity!.IsAuthenticated)
        {
            _navigationManager.NavigateTo("/");
        }
    }

    private async Task SubmitAsync()
    {
        var result = await _authenticationManager.Login(Model);
        if (result.IsSuccess)
        {
            _snackBar.Add(string.Format(Model.PhoneNumber), Severity.Success);
            _navigationManager.NavigateTo("/", true);
        }
        else
        {
            _snackBar.Add(result.MetaData.Message, Severity.Error);
        }
    }

    private bool _passwordVisibility;
    private InputType _passwordInput = InputType.Password;
    private string _passwordInputIcon = Icons.Material.Filled.VisibilityOff;

    void TogglePasswordVisibility()
    {
        if (_passwordVisibility)
        {
            _passwordVisibility = false;
            _passwordInputIcon = Icons.Material.Filled.VisibilityOff;
            _passwordInput = InputType.Password;
        }
        else
        {
            _passwordVisibility = true;
            _passwordInputIcon = Icons.Material.Filled.Visibility;
            _passwordInput = InputType.Text;
        }
    }
}